---
title: "R Notebook"
output: html_notebook
---

#Improvements with blockers: detection of low counts and DE sensitivity

These analyses used for Figure 4. Some analyses not used in figure, but included here for completeness.

Note: analyses performed on both miR counts generated by the Basespace small RNA app and by running miRDeep2 at the command line (default settings). Counts from Basespace small RNA app used in final analysis, but the option to use counts from miRDeep2 at the command line included here

Import libraries:
```{r}
suppressPackageStartupMessages(library(DESeq2))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(reshape2))
suppressPackageStartupMessages(library(metaseqR))
suppressPackageStartupMessages(library(plyr))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(PMCMR))
windowsFonts("Arial" = windowsFont("Arial"))
```


Functions used
```{r}
#Function that takes a column of counts and returns the number of species that pass the given list of threhsolds
CountsPassingThreshold<- function(counts, threshold){
  Passthreshold<-c()
  for (i in 1:length(threshold)){
    Passthreshold[i]<- sum(counts>threshold[i])
  }
  return(Passthreshold)
}

#When comparing DE efficiency in blocked vs unblocked, this function used to find species unique to blocked/unblocked and find raw counts for those species. Used for plotting.
GetCounts_UniqueDEmiRNA<- function(BlockedSig, UnblockedSig, SigLevel, RawCounts){
  #Get data frame of sig miRNAs for blocked and unblocked at given significance level
  NBSig<-UnblockedSig[UnblockedSig$padj<SigLevel,]
  BSig<- BlockedSig[BlockedSig$padj<SigLevel,]
  
  #Get DE miRNA specific to blocked and unblocked
  DEInUB<- rownames(as.data.frame(BSig)) %in% rownames(as.data.frame(NBSig))
  DEInB<- rownames(as.data.frame(NBSig)) %in% rownames(as.data.frame(BSig))
  OnlyBlockedDE<- BSig[!DEInUB,]
  OnlyUnBlockedDE<- BSig[!DEInB,]
  
  #Get raw counts for these miRNAs
  counts_onlyblockedDE<- RawCounts[rownames(RawCounts) %in% rownames(OnlyBlockedDE),]
  counts_onlyblockedDE<- counts_onlyblockedDE[,c(1:6,9:14)]
  counts_onlyblockedDE<-counts_onlyblockedDE[order(counts_onlyblockedDE$A.0, decreasing=TRUE),]
  
  counts_onlyunblockedDE<- RawCounts[rownames(RawCounts) %in% rownames(OnlyUnBlockedDE),]
  counts_onlyunblockedDE<- counts_onlyunblockedDE[,c(1:6,9:14)]
  counts_onlyunblockedDE<-counts_onlyunblockedDE[order(counts_onlyunblockedDE$A.1, decreasing=TRUE),]
  
  return(list(counts_onlyblockedDE, counts_onlyunblockedDE))
  
}

#Convienence function for getting sig DE species at certail sig level
GetSigSpecies<- function(SigLevel, res){
        return(res[res$padj < SigLevel,])
}

#Convienence function for collapsing A and B technical replicates
CollapseAandB<-function(counts){
        counts$A.0<- rowMeans(counts[,1:3])
        counts$B.0<- rowMeans(counts[,4:6])
        counts$A.1<- rowMeans(counts[,9:11])
        counts$B.1<- rowMeans(counts[,12:14])
        counts<-counts[,c(17,18,7,8,19,20,15,16)]
        colnames(counts)<-c("A.0", "B.0", "C.0", "D.0", "A.1", "B.1", "C.1", "D.1")
        return(counts)
}
```

#Overall steps:

1. Read in raw counts data (miRDeep2 Default settings OR BaseSpace counts) and downsample to common depth
2. Get number of species that pass certain thresholds, using mean across all samples (not used as figure)
3: Same analysis as above, but not using mean: subtracting unblocked # passing threshold from blocked # passing threshold for each sample (Figure 4A)
4: Differential expression: Comparing DE in blocked samples to DE in unblocked samples (Figure 4C-D)



#1: Read in data and downsample

Two input data options: pilot data from CL miRDeep2 analysis or pilot data from BaseSpace miRDeep2. Basespace data used for final figure
```{r}
#Read in raw couns from default CL miRDeep2 
countsInput<- read.csv("C:/Users/Jenna/Documents/BlockerProject/miRNA_CLmiRDeep2Results_AllSamples_DefaultmiRDeep2Settings.csv")
rownames(countsInput)<-countsInput$X
countsInput<- countsInput[,-1]
countsInput<- countsInput[,c(1,3,5,7,9,11,13,15,2,4,6,8,10,12,14,16)]
colnames(countsInput)<- c(paste(c("A:low", "A:medium", "A:high", "B:low", "B:medium", "B:high", "C", "D"), "-Unblocked",sep=""),
                          paste( c("A:low", "A:medium", "A:high","B:low", "B:medium", "B:high", "C", "D"), "-Blocked",sep="" ))


#Convert values to integer
counts<-as.data.frame(apply(countsInput, 2, as.integer))
rownames(counts)<- rownames(countsInput)
rownames(counts)<- gsub("hsa-", "", rownames(counts))

#Read in raw counts from Basespace- mature and isomir
wd<- "C:/Users/Jenna/Documents/BlockerProject/"
BaseSpace_countsInput<- read.delim(paste(wd, "mirna-blocker_bs_mature-isomirs_raw.txt", sep =""))
rownames(BaseSpace_countsInput)<- BaseSpace_countsInput$ID
BaseSpace_counts<-BaseSpace_countsInput[,c(4:ncol(BaseSpace_countsInput))]
colnames(BaseSpace_counts)<- c(paste(c("A:low", "A:medium", "A:high", "B:low", "B:medium", "B:high", "C", "D"), "-Unblocked",sep=""),
                          paste( c("A:low", "A:medium", "A:high","B:low", "B:medium", "B:high", "C", "D"), "-Blocked",sep="" ))

        #For basespace input count matrix: merge isomir and mature
        
        #Collapse counts-remove everything after 3rd "-" (-1, -5p, etc), then merge and sum together based on new miR IDs
        BaseSpace_collapsedInput<-BaseSpace_counts
        BaseSpace_collapsedInput$geneIDs<- sub("^([^-]*-[^-]*-[^-]*).*", "\\1", rownames(BaseSpace_collapsedInput))
        BaseSpace_collapsedInput$geneIDs<- gsub("mir", "miR", BaseSpace_collapsedInput$geneIDs)
        
        #Collapse isomirs and mature toegether
        BaseSpace_collapsed<-BaseSpace_collapsedInput %>% group_by(geneIDs) %>% summarise_each(funs(sum)) %>% as.data.frame
        rownames(BaseSpace_collapsed)<-BaseSpace_collapsed$geneIDs
        BaseSpace_collapsed<- BaseSpace_collapsed[,2:ncol(BaseSpace_collapsed)]
        rownames(BaseSpace_collapsed)<- gsub("hsa-", "", rownames(BaseSpace_collapsed))

#Set the input matrix to be used
countsInput<-BaseSpace_collapsed

#Downsample to common depth
counts<- downsample.counts(countsInput, set.seed(42)) #9,989,167 lowest B.570.0 /7.97 million for basespace
```



#2: Get number of species that pass certain thresholds, using mean across all samples (not used as figure)
```{r}
#Collapse technical replicates (by just taking mean of counts)
unblockedCounts<- as.data.frame(counts[,1:8])
unblockedCounts$ACollapsed<- rowMeans(unblockedCounts[,1:3])
unblockedCounts$BCollapsed<- rowMeans(unblockedCounts[,4:6])
unblockedCounts<-unblockedCounts[,c(9,10,7,8)]

#get mean counts across all 4 samples
unblockedCountsMeans<- as.data.frame((rowMeans(unblockedCounts)))

#number that pass thresholds:
unblockedPassThresholds<- data.frame(threshold=c(0,5,10,50,100,500), countsPassingThreshold=c(sum(unblockedCountsMeans>1),sum(unblockedCountsMeans>5),sum(unblockedCountsMeans>10),sum(unblockedCountsMeans>50),sum(unblockedCountsMeans>100),sum(unblockedCountsMeans>500)))

#blocked: collapse technical replicates (by just taking mean of counts)
blockedCounts<- as.data.frame(counts[,9:16])
blockedCounts$ACollapsed<- rowMeans(blockedCounts[,1:3])
blockedCounts$BCollapsed<- rowMeans(blockedCounts[,4:6])
blockedCounts<-blockedCounts[,c(9,10,7,8)]

#get mean counts across all 4 samples
blockedCountsMeans<- as.data.frame((rowMeans(blockedCounts)))

#number that pass thresholds:
blockedPassThresholds<- data.frame(threshold=c(0,5,10,50,100,500), countsPassingThreshold=c(sum(blockedCountsMeans>1),sum(blockedCountsMeans>5),sum(blockedCountsMeans>10),sum(blockedCountsMeans>50),sum(blockedCountsMeans>100),sum(blockedCountsMeans>500)))

#combine into one, adding in an extra column for blocker status
unblockedPassThresholds$status<- rep("unblocked",6)
blockedPassThresholds$status<- rep("blocked",6)
passThreshold<-rbind(unblockedPassThresholds,blockedPassThresholds)

#plot
p<- ggplot(passThreshold, aes(x=threshold, y=countsPassingThreshold, color=status))+
             geom_line(size=2)+
  geom_point(size=4)+
  scale_color_manual(values=c("black", "red"))+
  ggtitle("Number of miRNAs passing a count threshold")+
  theme_classic()
p
```


#3: Same analysis as above, but not using mean: subtracting unblocked # passing threshold from blocked # passing threshold for each sample (Figure 4A)
```{r}
#Set desired thresholds
thresholds<-c(3,5,10,25,50,75,100,250,500)
NumberInEachGroup<- length(thresholds)*5 #used for plotting later

#Get counts passing threshold for unblocked samples, then transform data- 4 columns: ID (A/b/c/d), threshold, #of species that passed that threshold, and blocker status
unblockedPassThreshold<- as.data.frame(apply(unblockedCounts, 2, 
                                             CountsPassingThreshold, thresholds))
rownames(unblockedPassThreshold)<- thresholds
colnames(unblockedPassThreshold)<- c("A", "B", "C", "D")
#add 4th column: mean of all samples
unblockedPassThreshold$Mean<- rowMeans(unblockedPassThreshold)
unblockedPassThreshold<- as.data.frame(t(unblockedPassThreshold))
unblockedPassThreshold$ID<- rownames(unblockedPassThreshold)
#reformat- melt
unblockedPassThreshold<- melt(unblockedPassThreshold)
colnames(unblockedPassThreshold)<- c("ID", "threshold","speciesPassingThreshold")
unblockedPassThreshold$status<- rep("unblocked", NumberInEachGroup)
unblockedPassThreshold$threshold<- as.integer(as.character((unblockedPassThreshold$threshold)))

#Get counts passing threshold for blocked samples, then transform data- 4 columns: ID (A/b/c/d), threshold, #of species that passed that threshold, and blocker status
blockedPassThreshold<- as.data.frame(apply(blockedCounts, 2, 
                                             CountsPassingThreshold, thresholds))
rownames(blockedPassThreshold)<- thresholds
colnames(blockedPassThreshold)<- c("A", "B", "C", "D")
#add 4th column: mean of all samples
blockedPassThreshold$Mean<- rowMeans(blockedPassThreshold)
blockedPassThreshold<- as.data.frame(t(blockedPassThreshold))
blockedPassThreshold$ID<- rownames(blockedPassThreshold)
#reformat- melt
blockedPassThreshold<- melt(blockedPassThreshold)
colnames(blockedPassThreshold)<- c("ID", "threshold","speciesPassingThreshold")
blockedPassThreshold$status<- rep("blocked", NumberInEachGroup)
blockedPassThreshold$threshold<- as.integer(as.character((blockedPassThreshold$threshold)))

#combine into one
passThreshold<-rbind(unblockedPassThreshold,blockedPassThreshold)

#reformat so that you have 4 columns: ID, threshold, #species passing in noblocker, #species passing in blocker
PT<-data.frame(passThreshold$ID[1:NumberInEachGroup],
               passThreshold$threshold[1:NumberInEachGroup],
               passThreshold$speciesPassingThreshold[1:NumberInEachGroup],
               passThreshold$speciesPassingThreshold[(NumberInEachGroup+1):nrow(passThreshold)])
colnames(PT)<- c("ID", "threshold", "SpeciesPT_noblocker", "SpeciesPT_blocker")

#now need to subtract each- i.e., sample A at threshold 1 with no blocker vs with blocker. get those values for all, then plot. 
df<- as_tibble(PT)
df<-df%>% group_by(ID) %>% mutate(BlockerMinusNoBlocker=SpeciesPT_blocker-SpeciesPT_noblocker)
df<- as.data.frame(df)
df$Mean<- rep(c(rep("Sample",4),"Mean"),length(thresholds))
df$Mean<- as.factor(df$Mean)

Samplecolors<- c("goldenrod1","violetred3", "skyblue3", "darkolivegreen4")

#plot
p<- ggplot(df, aes(x=threshold, y=BlockerMinusNoBlocker, color=ID))+
  geom_line(aes(linetype = Mean, group=ID, size=Mean))+
  scale_linetype_manual(values= c("solid", "dashed"),guide=FALSE)+
  scale_size_manual(values=c("Sample"=1.2,"Mean"=2), guide=FALSE)+
  #geom_point(size=1.3)+
  xlab("Count threshold")+
  ylab("n additional species detected in blocked libraries")+
  scale_y_continuous(breaks=seq(0, 250, 50), limits=c(0,250))+
  scale_x_continuous(breaks=seq(0, max(df$threshold), 50))+
  scale_color_manual(values=c("goldenrod1","violetred3", "skyblue3", "darkolivegreen4", "black"))+
  theme_classic()+
  guides(color = guide_legend(override.aes = list(size = 2)))+
  theme(axis.text.y   = element_text(size=12, colour = "black", face= "bold"),
        axis.title.y  = element_text(size=16, colour = "black", face= "bold"),
        axis.text.x   = element_text(size=12, colour = "black", face= "bold"),
        axis.title.x  = element_text(size=16, colour = "black", face= "bold"),
        panel.border = element_rect(colour = "black", fill=NA, size=2),
        legend.title=element_blank(),
        legend.position = c(.9,.85),
        legend.background = element_rect(fill=NA, size=1, linetype="solid", color="black"),
        legend.key.size = unit(.4, "cm"),
        legend.spacing.y = unit(0, "mm"),
        legend.text=element_text(size=14, face="bold"))
p

```


#4:  Differential expression: Comparing DE in blocked samples to DE in unblocked samples (Figure 4C-D)


Two analyses:

1) The 3 A.0 samples vs the 3 B.0 samples
2) The 3 A.1 samples vs the 3 B.1 samples


Analysis #1: DESeq2 using A0 vs B0 - here, technical replicates are NOT collapsed
```{r}
#rename rows, removing input info
A0_B0<- counts[,c(1:6)]
colnames(A0_B0)<- c("A.0.1", "A.0.2", "A.0.3", "B.0.1", "B.0.2", "B.0.3")


#create metadata
sampleGroup<- c(rep("A", 3), rep("B", 3))
sample<- colnames(A0_B0)
meta<- data.frame(sample, sampleGroup)

#create DESeq2 object
dds<- DESeqDataSetFromMatrix(countData=A0_B0, 
                             colData=meta, 
                             design=~sampleGroup)

#Run DESeq2
dds<- DESeq(dds)

#Extrac results
res<- na.omit(results(dds))
resOrdered<- res[order(res$padj),]
nrow(resOrdered[resOrdered$padj<0.05,]) #89 /BS: 71
nrow(resOrdered[resOrdered$padj<0.01,]) #60 /BS: 38

#Save for later
noblocker_AvB<- resOrdered
```

DESeq2 using A1 vs B1- here, technical replicates are NOT collapsed
```{r}
#rename rows, removing input info
A1_B1<- counts[,c(9:14)]
colnames(A1_B1)<- c("A.1.1", "A.1.2", "A.1.3", "B.1.1", "B.1.2", "B.1.3")

#create metadata
sampleGroup<- c(rep("A", 3), rep("B", 3))
sample<- colnames(A1_B1)
meta<- data.frame(sample, sampleGroup)

#create DESeq2 object
dds<- DESeqDataSetFromMatrix(countData=A1_B1, 
                             colData=meta, 
                             design=~sampleGroup)

#Run DESeq2
dds<- DESeq(dds)

#Extract results
res<- na.omit(results(dds))
resOrdered<- res[order(res$padj),]
nrow(resOrdered[resOrdered$padj<0.05,]) #119 / bs: 98
nrow(resOrdered[resOrdered$padj<0.01,]) #75 / BS: 60

#Save for later
blocker_AvB<- resOrdered
```


```{r}
(98-71)/98 #28% increase in the number of DE genes- BS
```

#Potential Supplemental Table: all miRs DE in either analysis + whether they were DE in both or one + pvalue + log2 FC + Raw counts for that species
```{r}
#merge blocked and unblocked sig miRs together
Blocker_sig<- as.data.frame(blocker_AvB[blocker_AvB$padj<0.05,c(2,6)])
colnames(Blocker_sig)<- c("Blocked_Log2FC", "Blocked_padj")
Noblocker_sig<- as.data.frame(noblocker_AvB[noblocker_AvB$padj<0.05,c(2,6)])
colnames(Noblocker_sig)<- c("Unblocked_Log2FC", "Unblocked_padj")
allSig<- merge(Blocker_sig, Noblocker_sig, by=0, all=TRUE) #145 total
rownames(allSig)<-allSig$Row.names

#Collapse A and B tech replicates
CountsCollapsed<-CollapseAandB(counts)

#Get mean raw counts of 4 blocked libs and 4 unblocked libs
RawCounts_Unblocked<-as.data.frame(rowMeans(CountsCollapsed[rownames(CountsCollapsed) %in% rownames(allSig),1:4]))
colnames(RawCounts_Unblocked)<- "RawCounts_Unblocked"

RawCounts_Blocked<-as.data.frame(rowMeans(CountsCollapsed[rownames(CountsCollapsed) %in% rownames(allSig),5:8]))
colnames(RawCounts_Blocked)<- "RawCounts_Blocked"

#Merge counts with sig values
allSigWithUnblocked<-merge(allSig,RawCounts_Unblocked,by=0)
rownames(allSigWithUnblocked)<- allSigWithUnblocked$Row.names
allSigWithCounts<-merge(allSigWithUnblocked, RawCounts_Blocked, by=0)

allSigWithCounts<-allSigWithCounts[,-1]
```


#Plot the number of sig DE miRs at 2 sig thresholds for blocked and unblocked analyses (Figure 4C)
```{r}
#Get list of sig miRs at given sig levels 
SigLevels<- c(0.1, 0.05, 0.01)
blocked_Sig<-lapply(SigLevels, GetSigSpecies, res=blocker_AvB)
unblocked_Sig<-lapply(SigLevels, GetSigSpecies, res=noblocker_AvB)

#Get number of sig miRs at given sig levels
blocked_NSig<- unlist(lapply(blocked_Sig, nrow))
unblocked_NSig<- unlist(lapply(unblocked_Sig, nrow))

#Merge into one df for plotting
df<- data.frame(Sig=as.factor(SigLevels), Blocked=blocked_NSig, Unblocked=unblocked_NSig)
df<- melt(df)
df$Order<- c(rep(2,3), rep(1,3))

#remove sig 0.1 threshold- optional
df<-df[df$Sig!="0.1",]

#plot:
p<- ggplot(df, aes(x=reorder(Sig, -value), y=value, fill=variable, group=Order))+
        geom_bar(position="dodge", stat="identity")+
        scale_fill_manual(values=c(Blocked="firebrick3", Unblocked="turquoise3"))+
        theme_classic()+
        xlab("Signficance threshold (p<)")+
        ylab("Number of Significant miRs")+
        theme(axis.title.x=element_text(size=16, face="bold"),
              axis.title.y=element_text(size=16, face="bold"),
              axis.text.x= element_text(size=14, face="bold", color="black"),
              axis.text.y=element_text(size=14, face="bold", color="black"),
              legend.title = element_blank(),
              legend.text = element_text(size=14, face="bold"),
              legend.background = element_rect(fill=NA, size=1, 
                                  linetype="solid", color="black"),
              legend.position = c(.72,.9),
              panel.border = element_rect(colour = "black", fill=NA, size=2))


```

#Get miRs unique to each analysis or found in both, then calculate statistics needed for figure 4E
```{r}
#Get miRs DE at 0.05 or 0.01
Blocked_5<-as.data.frame(blocked_Sig[[2]]) #119
Blocked_1<-as.data.frame(blocked_Sig[[3]]) #75
Unblocked_5<-as.data.frame(unblocked_Sig[[2]]) #89
Unblocked_1<-as.data.frame(unblocked_Sig[[3]]) #60

#Get miRs specific to blocked or unblocked or in both
Blocked_5_Unique<- Blocked_5[!(rownames(Blocked_5) %in% rownames(Unblocked_5)),] #56
Blocked_1_Unique<- Blocked_1[!(rownames(Blocked_1) %in% rownames(Unblocked_1)),] #30
Unblocked_5_Unique<- Unblocked_5[!(rownames(Unblocked_5) %in% rownames(Blocked_5)),] #26
Unblocked_1_Unique<- Unblocked_1[!(rownames(Unblocked_1) %in% rownames(Blocked_1)),] #15
Both_5<-merge(Blocked_5, Unblocked_5, by=0)
rownames(Both_5)<-Both_5$Row.names
Both_5<-Both_5[,-1]
Both_1<-merge(Blocked_1, Unblocked_1, by=0)
rownames(Both_1)<-Both_1$Row.names
Both_1<-Both_1[,-1]

#Get raw counts for these species- using collapsed counts
Blocked_5_Counts<-CountsCollapsed[rownames(CountsCollapsed)%in% rownames(Blocked_5_Unique),]
Blocked_1_Counts<-CountsCollapsed[rownames(CountsCollapsed)%in% rownames(Blocked_1_Unique),]
Unblocked_5_Counts<-CountsCollapsed[rownames(CountsCollapsed)%in% rownames(Unblocked_5_Unique),]
Unblocked_1_Counts<-CountsCollapsed[rownames(CountsCollapsed)%in% rownames(Unblocked_1_Unique),]
Both_5_Counts<-CountsCollapsed[rownames(CountsCollapsed) %in% rownames(Both_5),]
Both_1_Counts<-CountsCollapsed[rownames(CountsCollapsed) %in% rownames(Both_1),]

#row means --> median of these raw counts. A couple of options:
#row means across all 8 libraries
median(rowMeans(Blocked_5_Counts)) #27
median(rowMeans(Blocked_1_Counts)) #39
median(rowMeans(Unblocked_5_Counts)) #166
median(rowMeans(Unblocked_1_Counts)) #103
median(rowMeans(Both_5_Counts)) #552
median(rowMeans(Both_1_Counts)) #553

#row means across 4 libraries
median(rowMeans(Blocked_5_Counts[,5:8])) #45
median(rowMeans(Blocked_1_Counts[,5:8])) #65
median(rowMeans(Unblocked_5_Counts[,1:4])) #43
median(rowMeans(Unblocked_1_Counts[,1:4])) #32

#Get number of miRs with counts >100
sum(rowMeans(Blocked_5_Counts[,5:8])>50) #20 /24
sum(rowMeans(Blocked_5_Counts[,5:8])>100)/nrow(Blocked_5_Counts) #45% / 54%

sum(rowMeans(Unblocked_5_Counts[,1:4])>50) #6 / 6
sum(rowMeans(Unblocked_5_Counts[,1:4])>100)/nrow(Unblocked_5_Counts) #35% /35%

sum(rowMeans(Both_5_Counts)>50) #39/46
sum(rowMeans(Both_5_Counts)>50)/nrow(Both_5_Counts) #72% /85%
```

#Get DE miRs specific to blocked or unblocked or common to both --> Raw counts --> plot Median raw counts (Figure 4D)
```{r}
#Get miRs that are specific to blocked/unblocked at each sig level
blocked_unique<-list()
unblocked_unique<- list()

for (i in 1:length(blocked_Sig)){
        blocked<- blocked_Sig[[i]]
        unblocked<- unblocked_Sig[[i]]
        blocked_unique[[i]]<- blocked[!(rownames(blocked) %in% rownames(unblocked)),]
        unblocked_unique[[i]]<- unblocked[!(rownames(unblocked)%in% rownames(blocked)),]
}


#get raw counts for the blocked/unblocked specific miRs and miRs found in both analyses 
blocked_unique_rawCounts<- lapply(blocked_unique, function(x){
        CollapseAandB(counts[rownames(counts) %in% rownames(x),])
})

unblocked_unique_rawCounts<- lapply(unblocked_unique, function(x){
        CollapseAandB(counts[rownames(counts) %in% rownames(x),])
})

CommonDE_RawCounts<-list()
for (i in 1:length(blocked_Sig)){
        blocked<- blocked_Sig[[i]]
        unblocked<- unblocked_Sig[[i]]
        CommonDE<- rownames(blocked[rownames(blocked) %in% rownames(unblocked),])
        CommonDE_RawCounts[[i]]<- CollapseAandB(counts[rownames(counts) %in% CommonDE,])
}

#merge all 3 groups into one list, then add a column denoting significance level
AllRaw<-c(unblocked_unique_rawCounts, blocked_unique_rawCounts, CommonDE_RawCounts)
Sigs<-rep(SigLevels, 3)
AllWithSig<- c()
for (i in 1:length(AllRaw)){
        df<-AllRaw[[i]]
        df$Sig<- Sigs[i]
        AllWithSig[[i]]<-df
        
}

#calculate rowmean of each miR for each sig level for all3 groups 
UB_rowmean<-c()
for (i in 1:3){
        df<-AllWithSig[[i]]
        df$Mean<- rowMeans(df[,1:4])
        df$Group<- "Unblocked"
        UB_rowmean[[i]]<-df[,9:11]
}

B_rowmean<-c()
for (i in 4:6){
        df<-AllWithSig[[i]]
        df$Mean<- rowMeans(df[,5:8])
        df$Group<- "Blocked"
        B_rowmean[[i]]<-df[,9:11]
}

Common_rowmean<-c()
for (i in 7:9){
        df<-AllWithSig[[i]]
        df$Mean<- rowMeans(df[,1:8])
        df$Group<- "Common"
        Common_rowmean[[i]]<-df[,9:11]
}

#Bind all 3 significance levels together for all 3 groups
UB_all<-do.call("rbind", UB_rowmean)
B_all<-do.call("rbind", B_rowmean)
Common_all<-do.call("rbind", Common_rowmean)

#Bind all 3 groups together
AllMeans<-rbind(UB_all, B_all, Common_all)
AllMeans$Group<- as.factor(AllMeans$Group)

#Perform dunn post-hoc comparing all 3 groups at every significance level
posthoc.kruskal.dunn.test(AllMeans[grep("0.01", AllMeans$Sig),2], g=AllMeans[grep("0.01", AllMeans$Sig),3]) 
        #Common vs Blocked: p=.00041 / Unblocked vs Blocked: p=0.458 / Unblocked vs Common: p=0.0097

posthoc.kruskal.dunn.test(AllMeans[grep("0.05", AllMeans$Sig),2], g=AllMeans[grep("0.05", AllMeans$Sig),3]) 
        #Common vs Blocked: p=.0072 / Unblocked vs Blocked: p=0.352 / Unblocked vs Common: p=0.0062

#Calculate median counts of miRs for each group
UB_df<- UB_all %>% dplyr::group_by(Sig) %>% dplyr::summarise(median=median(as.numeric(Mean)))  %>% mutate(Group="Unblocked") %>% as.data.frame()

B_df<- B_all %>% dplyr::group_by(Sig) %>% dplyr::summarise(median=median(as.numeric(Mean))) %>% mutate(Group="Blocked") %>% as.data.frame()

Common_df<- Common_all %>% dplyr::group_by(Sig) %>% dplyr::summarise(median=median(as.numeric(Mean))) %>% mutate(Group="CommonDE") %>% as.data.frame()

#Bind all 3 groups into one dataframe
All_df<-rbind(UB_df, B_df, Common_df)
All_df<-All_df[All_df$Sig!="0.1",] #Get rid of 0.1 sig level
All_df$Order<- c(rep(2,2), rep(3,2), rep(1,2))

#Plot
p<- ggplot(All_df, aes(x=as.character(Sig), y=median, fill=Group, group=Order))+
        geom_bar(stat="identity", position="dodge")+
        scale_fill_manual(values=c(Blocked="firebrick3", Unblocked="turquoise3", CommonDE="grey"))+
        theme_classic()+
        xlab("Signficance threshold (p<)")+
        ylab("Median Raw counts for DE miRs \n specific to blocked or unblocked DE analysis")+
        theme(axis.title.x=element_text(size=16, face="bold"),
              axis.title.y=element_text(size=16, face="bold"),
              axis.text.x= element_text(size=14, face="bold", color="black"),
              axis.text.y=element_text(size=14, face="bold", color="black"),
              legend.title = element_blank(),
              legend.text = element_text(size=10, face="bold"),
              legend.background = element_rect(fill=NA, size=1, 
                                  linetype="solid", color="black"),
              legend.position = c(.8,.9),
              panel.border = element_rect(colour = "black", fill=NA, size=2))

```

```{r}
sessionInfo()
```

