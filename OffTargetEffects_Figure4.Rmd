---
title: "R Notebook"
output: html_notebook
---

#Exploring potential off-target effects of blockers- sig DE non-target miRs

These analyses used for Figure 3A.

Note: analyses performed on both miR counts generated by the Basespace small RNA app and by running miRDeep2 at the command line (default settings). Counts from Basespace small RNA app used in final analysis, but the option to use counts from miRDeep2 at the command line included here


Import libraries:
```{r}
suppressPackageStartupMessages(library(metaseqR))
suppressPackageStartupMessages(library(DESeq2))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(ggrepel))
suppressPackageStartupMessages(library(dplyr))
```


Functions
```{r}
#Create metadata and DESeq2 object, then run DESeq2
RunDESeq2<- function(counts,meta, collapseRep=TRUE) {
  #create DESeq2 object- just based on samplegroup (blockerstatus)
  #will add samples to model later (i.e., pairwise analysis)
  dds<- DESeqDataSetFromMatrix(countData=counts, 
                               colData=meta, 
                               design=~sampleGroup)
  #Collapse technical replicates using internal DESeq2 function
  if (collapseRep ==TRUE){
    dds<- collapseReplicates(dds, dds$sample)
  }
  
  #Create model that takes into account sample differences
  ddsMF<- dds
  design(ddsMF)<- formula(~Patient + sampleGroup)
  
  #run DESeq2
  dds<- DESeq(ddsMF)
  
  return(dds)
}

#Get DE results
GetDEResults<- function(dds){
  res<- results(dds)
  res<- na.omit(res)
  resOrdered<- res[order(res$padj),]
  print(nrow(resOrdered[resOrdered$padj<0.05,]))
  print(nrow(resOrdered[resOrdered$padj<0.01,]))
  return(resOrdered)
}
```


#Notes on DESeq2 Analysis:

-Since there are 4 sample types (A/B/C/D) each with at least one blocked/unblocked pair, pairwise DESeq2 analysis is performed

-Samples A and B have 3 technical replicates, for both blocked and unblocked groups. These technical replicates are collapsed using an internal DESeq2 function. These technical replicates have varying RNA input amounts into library construction, but this was determined to have no effect on the resulting libraries (See Figure1A Notebook). This is additionally confirmed by PCA clustering here.


#Overall steps:

1. Read in raw counts data (miRDeep2 Default settings OR BaseSpace counts) and downsample to common depth
2. Perform DE- same analysis as in "GlobalEffects_Figure2.Rmd", but included here for completeness. Used for determining potential off target miRs
3: Plot off target effects- considering log2FC, padj, and total raw counts (Figure 3A)


#1: Read in data and downsample

Two input data options: pilot data from CL miRDeep2 analysis or pilot data from BaseSpace miRDeep2. Basespace data used for final figure
```{r}
#Read in raw couns from default CL miRDeep2 
countsInput<- read.csv("C:/Users/Jenna/Documents/BlockerProject/miRNA_CLmiRDeep2Results_AllSamples_DefaultmiRDeep2Settings.csv")
rownames(countsInput)<-countsInput$X
countsInput<- countsInput[,-1]
countsInput<- countsInput[,c(1,3,5,7,9,11,13,15,2,4,6,8,10,12,14,16)]
colnames(countsInput)<- c(paste(c("A:low", "A:medium", "A:high", "B:low", "B:medium", "B:high", "C", "D"), "-Unblocked",sep=""),
                          paste( c("A:low", "A:medium", "A:high","B:low", "B:medium", "B:high", "C", "D"), "-Blocked",sep="" ))


#Convert values to integer
counts<-as.data.frame(apply(countsInput, 2, as.integer))
rownames(counts)<- rownames(countsInput)

#Read in raw counts from Basespace- mature and isomir
wd<- "C:/Users/Jenna/Documents/BlockerProject/"
BaseSpace_countsInput<- read.delim(paste(wd, "mirna-blocker_bs_mature-isomirs_raw.txt", sep =""))
rownames(BaseSpace_countsInput)<- BaseSpace_countsInput$ID
BaseSpace_counts<-BaseSpace_countsInput[,c(4:ncol(BaseSpace_countsInput))]
colnames(BaseSpace_counts)<- c(paste(c("A:low", "A:medium", "A:high", "B:low", "B:medium", "B:high", "C", "D"), "-Unblocked",sep=""),
                          paste( c("A:low", "A:medium", "A:high","B:low", "B:medium", "B:high", "C", "D"), "-Blocked",sep="" ))

        #For basespace input count matrix: merge isomir and mature
        
        #Collapse counts-remove everything after 3rd "-" (-1, -5p, etc), then merge and sum together based on new miR IDs
        BaseSpace_collapsedInput<-BaseSpace_counts
        BaseSpace_collapsedInput$geneIDs<- sub("^([^-]*-[^-]*-[^-]*).*", "\\1", rownames(BaseSpace_collapsedInput))
        BaseSpace_collapsedInput$geneIDs<- gsub("mir", "miR", BaseSpace_collapsedInput$geneIDs)
        
        #Collapse isomirs and mature toegether
        BaseSpace_collapsed<-BaseSpace_collapsedInput %>% group_by(geneIDs) %>% summarise_each(funs(sum)) %>% as.data.frame
        rownames(BaseSpace_collapsed)<-BaseSpace_collapsed$geneIDs
        BaseSpace_collapsed<- BaseSpace_collapsed[,2:ncol(BaseSpace_collapsed)]
        rownames(BaseSpace_collapsed)<- gsub("hsa-", "", rownames(BaseSpace_collapsed))

#Set the input matrix to be used
countsInput<-BaseSpace_collapsed

#Downsample to common depth
counts<- downsample.counts(countsInput, set.seed(42)) #9,989,167 lowest B.570.0 /7.97 million for basespace
```


#2:  Perform DE- same analysis as in "GlobalEffects_Figure2.Rmd", but included here for completeness. Used for determining potential off target miRs
Reformat, create metadata
```{r}
#rename rows, removing input info
colnames(counts)<- c(rep("A.0", 3), rep("B.0", 3), "C.0", "D.0", rep("A.1", 3), rep("B.1", 3), "C.1", "D.1")

#Create metadata
sampleGroup<- factor(c(rep("Unblocked", 8), rep("Blocked", 8)), levels=c("Unblocked", "Blocked")) #set blocker status
sample<- colnames(counts) #this column is used to collapse technical replicates
Patient<- as.factor(c(rep("A", 3), rep("B", 3), "C", "D", rep("A", 3), rep("B", 3), "C", "D")) #this column is to control for sample to sample differences
meta<- data.frame(sample, sampleGroup, Patient)
```


#Perform DE

Filtering: 
1)only keep species with at least 1 CPM in at least 2 samples in BOTH blocked and unblocked groups
2)Targets NOT removed
        
Technical replicates in samples A and B are collapsed, pairwise analysis

Filter count matrix:
Remove all species that don't meet a cpm threshold: >1 cpm in more than 1 sample in each group
```{r}
#Collapse A and B technical replicates
counts_collapsed<-counts
counts_collapsed$A.0.c<-rowMeans(counts_collapsed[,1:3])
counts_collapsed$B.0.c<-rowMeans(counts_collapsed[,4:6])
counts_collapsed$A.1.c<-rowMeans(counts_collapsed[,9:11])
counts_collapsed$B.1.c<-rowMeans(counts_collapsed[,12:14])
counts_collapsed<- counts_collapsed[,c(17,18,7,8,19,20,15,16)]

#Calculate cpm. convert to integer
counts_cpm<- counts_collapsed /colSums(counts_collapsed) *1000000
counts_cpm<- apply(counts_cpm, 2, as.integer)
rownames(counts_cpm)<-rownames(counts_collapsed)

#Remove all species that don't have more than 1 unblocked sample with cpm > 1
UnblockedPass<- counts_cpm[rowSums(counts_cpm[,1:4]>1)>1,] #- #2261 species removed- a lot of unblocked don't meet threshold. makes sense.

#Remove all species that don't have at least 1 blocked sample with cpm> 1
BlockedandUnblockedPass<- UnblockedPass[rowSums(UnblockedPass[,5:8]>1)>1,] #none removed

#Get species that passed, filter counts based on this
counts_CPMfilter<- counts[rownames(counts) %in% rownames(BlockedandUnblockedPass),]
```


Create dds object, run DESeq2
```{r}
#Run DESeq2
#Technical replicates are collapsed and pairwise analysis performed
dds<- RunDESeq2(counts_CPMfilter,meta,TRUE)
```

Extract DESeq2 results 
```{r}
resOrdered<- GetDEResults(dds)
#38/26 DE miRNAs- CL
#30/22 DE miRNAs- BS

sig<- as.data.frame(resOrdered[resOrdered$padj<0.05,])
sig<- sig[,c(1,2,6)]
```

#3: Plot off target effects- considering log2FC, padj, and total raw counts (Figure 3A)

Collect all needed data into one df:
```{r}
#Add in raw count data for these miRNAs- across all 16 libraries
Unblocked_RawCounts<- as.data.frame(rowMeans(counts_cpm[rownames(counts_cpm) %in% rownames(sig),1:4]))
Blocked_RawCounts<- as.data.frame(rowMeans(counts_cpm[rownames(counts_cpm) %in% rownames(sig),5:8]))
OT<- merge(sig, Unblocked_RawCounts, by=0)
rownames(OT)<-OT$Row.names
colnames(OT)<- c("Species", "baseMean", "log2FoldChange", "padj", "MeanCPMUnblockedCounts")
OT<- merge(OT, Blocked_RawCounts, by=0)
OT<-OT[,-1]
colnames(OT)<- c("Species", "baseMean", "log2FoldChange", "padj", "MeanCPMUnblockedCounts", "MeanCPMBlockedCounts")
OT$MeanRawCounts<- rowMeans(OT[,5:6])

#Annotate by whether species is a target miR
#ActualTargets<- c('miR-486-5p','miR-92a-3p','miR-451a') #CL
ActualTargets<- c('miR-486','miR-92a','miR-451a') #BS
OT$Target<- OT$Species %in% ActualTargets

#Entire list of all species in target family
#Target_92<- rownames(counts[grep("miR-92", rownames(counts))[5:8],]) #CL
Target_92<- rownames(counts[grep("miR-92", rownames(counts))[5:6],]) #BS

#Target_451<- rownames(counts[grep("miR-451", rownames(counts))[11],]) #CL
Target_451<- rownames(counts[grep("miR-451", rownames(counts))[11:12],]) #BS

Target_486<- rownames(counts[grep("miR-486", rownames(counts)),]) #CL or BS

Target_25<- rownames(counts[grep("miR-25", rownames(counts)),]) #CL or BS

TargetFamilies<- c(Target_451,Target_486,Target_92, Target_25)
OT$TargetFamily<- OT$Species %in% TargetFamilies
OT$Color<- as.factor(rowSums(OT[,c(8,9)]))
OT$Color<- gsub(0, "Non-Target miR", OT$Color)
OT$Color<- gsub(1, "miR in Target Family", OT$Color)
OT$Color<- gsub(2, "Target miR", OT$Color)


#set which miRs to be labeled on graph
SubsetToLabel<- OT[OT$Color %in% c("Target miR", "miR in Target Family"),]
SubsetToLabel$Species<- gsub("hsa-", "", SubsetToLabel$Species)
```

Plotting- figure 3A
```{r}
#plot
p<-ggplot(OT,aes(x=log2FoldChange, y= padj, fill=Color))+
  geom_point(aes(size=MeanRawCounts), pch=21, color="black")+
  scale_size_continuous(range = c(1, 50), guide=FALSE)+
  scale_x_continuous(limits=c(-6,6),n.breaks = 7)+
  scale_y_continuous(limits = c(-0.008, .05))+
  theme_classic()+
  xlab("log2 foldchange of differential expression")+
  ylab("Adjusted p value")+
  geom_vline(xintercept=0,linetype="dotted", color= "black", size=1.25)+
  guides(colour = guide_legend(override.aes = list(size=5)))+
  geom_text_repel(data=SubsetToLabel, aes(x=log2FoldChange, y=padj, 
                                          label=Species),
                                          size=3.5, fontface= "bold",
                                          nudge_y = 0.0035, point.padding = 1.7, 
                                          box.padding = 0.5)+
  scale_fill_manual(values=c("orange","black", "red"))+
  theme(axis.text.y   = element_text(size=12, face= "bold", colour = "black"),
        axis.title.y  = element_text(size=16, face= "bold", colour = "black"),
        axis.title.x  = element_text(size=16, face="bold", colour = "black"),
        axis.text.x  = element_text(size=12, face="bold", colour = "black"),
        legend.background = element_rect(fill=NA, size=1, 
                                         linetype="solid", color="black"),
        legend.title=element_blank(),
        legend.key.size = unit(.4, "cm"),
        legend.spacing.y = unit(0, "mm"),
        legend.position = c(.8,.93),
        panel.border = element_rect(colour = "black", fill=NA, size=2),
        legend.text = element_text(size=13, face="bold"))

p
```


