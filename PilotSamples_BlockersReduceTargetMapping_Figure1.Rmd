---
title: "R Notebook"
output: html_notebook
---

#Effect of blocking oligos on target detection

These analyses used for Figure 1 or for supplemental figure 1

Note: most analyses performed on both miR counts generated by the Basespace small RNA app and by running miRDeep2 at the command line (default settings). Counts from Basespace small RNA app used in final analysis, but the option to use counts from miRDeep2 at the command line included here.

Import libraries
```{r}
suppressPackageStartupMessages(library(metaseqR))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(reshape2))
suppressPackageStartupMessages(library(dplyr))
windowsFonts("Arial" = windowsFont("Arial"))
```

Functions:
```{r}
#Input is the percentage of reads mapping for the 3 target species, for 1 patient, for all 3 inputs, either blocked or unblocked. species ids are in the rows. each column is an input level.
My_ANOVA<- function(PM){
        #Create DF for Anova
        PM$ID<-rownames(PM)
        PM<-melt(PM)
        PM$variable<- gsub("-.*", "", PM$variable)
        colnames(PM)<- c("IDs", "Input", "PM")
        new<- within(PM, {
          IDs<- factor(IDs)
          Input<- factor(Input)
        })
        myData.mean<- aggregate(new$PM,
                             by = list(new$IDs, new$Input),
                             FUN='mean')
        colnames(myData.mean)<- c("ID", "Input", "PM")
        myData.mean<- myData.mean[order(myData.mean$ID),]
        
        #Run anova, controling for species and input level
        stress.aov <- with(myData.mean,
                           aov(PM ~ Input +
                               Error(ID / Input)))
        return(summary(stress.aov))
}
```


#Overall steps:

1. Read in raw counts data (miRDeep2 Default settings OR BaseSpace counts) and downsample to common depth
2. Get proportion mapping to any target --> mean % across unblocked/blocked --> plot (Supplemental Figure 1A)
3. Graph % for any target for 8 unblocked vs 8 blocked (Figure 1B)
4. Run ANOVA for demonstrating no difference between 3 inputs for A/B (Figure 1B)
5. Graph % for mapping to 3 targets (or 11 targets if Basespace isomirs/mature are separated) individually for 4 unblocked vs 4 blocked



#1: Read in data and downsample

Two input data options: pilot data from CL miRDeep2 analysis or pilot data from BaseSpace miRDeep2. Basespace data used for final figure
```{r}
#Read in raw couns from default CL miRDeep2 
wd<- "D:/AsusFiles/BlockerProject/"
countsInput<- read.csv(paste(wd, "miRNA_CLmiRDeep2Results_AllSamples_DefaultmiRDeep2Settings.csv",sep=""))
rownames(countsInput)<-countsInput$X
countsInput<- countsInput[,-1]
countsInput<- countsInput[,c(1,3,5,7,9,11,13,15,2,4,6,8,10,12,14,16)]
colnames(countsInput)<- c(paste(c("A:low", "A:medium", "A:high", "B:low", "B:medium", "B:high", "C", "D"), "-Unblocked",sep=""),
                          paste( c("A:low", "A:medium", "A:high","B:low", "B:medium", "B:high", "C", "D"), "-Blocked",sep="" ))


#Convert values to integer
counts<-as.data.frame(apply(countsInput, 2, as.integer))
rownames(counts)<- rownames(countsInput)
rownames(counts)<- gsub("hsa-", "", rownames(counts))

#Read in raw counts from Basespace- mature and isomir
BaseSpace_countsInput<- read.delim(paste(wd, "mirna-blocker_bs_mature-isomirs_raw.txt", sep =""))
rownames(BaseSpace_countsInput)<- BaseSpace_countsInput$ID
BaseSpace_counts<-BaseSpace_countsInput[,c(4:ncol(BaseSpace_countsInput))]
colnames(BaseSpace_counts)<- c(paste(c("A:low", "A:medium", "A:high", "B:low", "B:medium", "B:high", "C", "D"), "-Unblocked",sep=""),
                          paste( c("A:low", "A:medium", "A:high","B:low", "B:medium", "B:high", "C", "D"), "-Blocked",sep="" ))

        #For basespace input count matrix: merge isomir and mature
        
        #Collapse counts-remove everything after 3rd "-" (-1, -5p, etc), then merge and sum together based on new miR IDs
        BaseSpace_collapsedInput<-BaseSpace_counts
        BaseSpace_collapsedInput$geneIDs<- sub("^([^-]*-[^-]*-[^-]*).*", "\\1", rownames(BaseSpace_collapsedInput))
        BaseSpace_collapsedInput$geneIDs<- gsub("mir", "miR", BaseSpace_collapsedInput$geneIDs)
        
        #Collapse isomirs and mature toegether
        BaseSpace_collapsed<-BaseSpace_collapsedInput %>% group_by(geneIDs) %>% summarise_each(funs(sum)) %>% as.data.frame
        rownames(BaseSpace_collapsed)<-BaseSpace_collapsed$geneIDs
        BaseSpace_collapsed<- BaseSpace_collapsed[,2:ncol(BaseSpace_collapsed)]
        rownames(BaseSpace_collapsed)<- gsub("hsa-", "", rownames(BaseSpace_collapsed))

#Set the input matrix to be used
countsInput<-BaseSpace_collapsed

#Downsample to common depth
counts<- downsample.counts(countsInput, set.seed(42)) #9,989,167 lowest B.570.0 /7.97 million for basespace
```



#2. Get proportion mapping to any target --> mean % across unblocked/blocked --> plot (Supplemental Figure 1A)
```{r}
#Get raw, downsampled counts for all 3 targets for al 16 samples
        #MapAnyTarget<- counts[rownames(counts) %in% c("hsa-miR-92a-3p", "hsa-miR-451a", "hsa-miR-486-5p"),] #for CL
        MapAnyTarget<- counts[rownames(counts) %in% c("miR-92a", "miR-451a", "miR-486"),] #for basespace collapsed

#Get percentage of total for all 3 counts for all 16 samples 
PercentMapTo3Targets<- MapAnyTarget/colSums(counts) * 100

#Get Percentage of total for ANY target for all 16 samples
PercentMapToAnyTarget<- colSums(PercentMapTo3Targets)

#Get mean percentage mapping to ANY target for blocked and unblocked
MeanPercentages_AcrossWholeGroup<- c(mean(PercentMapToAnyTarget[1:8]), mean(PercentMapToAnyTarget[9:16]))
SDPercentages_AcrossWholeGroup<- c(sd(PercentMapToAnyTarget[1:8]), sd(PercentMapToAnyTarget[9:16]))
Per_AnyTarget_TwoGroups<- data.frame(Status=c("Unblocked", "Blocked"), MeanPercentMapping=MeanPercentages_AcrossWholeGroup, sd=SDPercentages_AcrossWholeGroup)

#plot
p<-ggplot(Per_AnyTarget_TwoGroups, aes(y=MeanPercentMapping, x=reorder(Status, - MeanPercentMapping),fill=Status))+
  geom_bar(stat="identity", position="dodge", width=.7)+ 
  theme_classic()+
  ylab("Percent of reads mapping to targets species")+
  xlab("")+
  scale_fill_manual("", values=c("Blocked"="firebrick3", "Unblocked"="turquoise3"))+
  geom_errorbar(aes(ymin=MeanPercentMapping-sd, ymax=MeanPercentMapping+sd), width=.1, size=1, position=position_dodge(.9),color="black")+
  ylim(0,100)+
  theme(axis.text.y   = element_text(size=12, color="black", face= "bold"),
          axis.text.x   = element_text(size=14, color="black", face="bold"),
          axis.title.y  = element_text(size=14, color="black", "bold"),
          panel.border = element_rect(colour = "black", fill=NA, size=2),
          legend.title=element_blank(),
          legend.position = "none",
          legend.background = element_rect(fill=NA, size=1, linetype="solid", color="black"),
          axis.text.x.bottom  =element_text(size=20))
 
```

Running significance test to compare blocked and unblocked
```{r}
#T test comparing blocked and unblocked
t.test(unname(PercentMapToAnyTarget[1:8]),unname(PercentMapToAnyTarget[9:16]), paired=TRUE)
#p-value = 3.926e-08 / BS: 7.6e-8
```



#3. Graph % for any target for 8 unblocked vs 8 blocked (Figure 1B)
```{r}
#Get percent mapping to any target, split by sample. Technical replicates for A and B are NOT collapsed
JustReplicated<-PercentMapToAnyTarget
Per_AnyTarget_16Samples<- data.frame(Status=c(rep("Unblocked",8),rep( "Blocked",8)), 
                                     PM=unname(JustReplicated),
                                     Input=gsub(".*:", "", gsub("-.*", "", names(JustReplicated))),
                                     Patient=paste("Sample", substr(names(JustReplicated), 1,1)),
                                     Order = c(1,2,3,7,8,9,13,15,4,5,6,10,11,12,14,16),
                                     Sample=gsub("-.*", "", names(JustReplicated)))

#Plot: all samples on same graph, coloring based on sample
Samplecolors<- c("goldenrod1","violetred3", "skyblue3", "darkolivegreen4")
p<-ggplot(Per_AnyTarget_16Samples, aes(y=PM, x=reorder(Status,+Order),group= Sample,fill=Patient))+
  geom_bar(stat="identity", position=position_dodge(width=0.8), width=.7)+ 
  facet_wrap(~Patient, nrow=1)+     
  theme_classic()+
  ylab("Percent of reads mapping to target species")+
  xlab("")+
  scale_fill_manual("", values=c("goldenrod1","violetred3", "skyblue3", "darkolivegreen4"))+
  ylim(0,100)+
  theme(axis.text.y   = element_text(size=14, color="black", face="bold"),
        axis.text.x   = element_text(size=14, color="black", face="bold", angle=45, hjust=1),
        axis.title.y  = element_text(size=14, color="black", face="bold"),
        #panel.border = element_rect(colour = "black", fill=NA, size=2), 
                               strip.background = element_blank(),
        legend.title=element_blank(),
        legend.text=element_text(size=12, face="bold"),
        #legend.position=c(.85,.9), 
        legend.position=c(.12,.9),
        #legend.position="none",
        legend.background = element_rect(fill=NA, size=1, linetype="solid", color="black"),
        strip.text.x = element_blank()
        )

```


#4. Run ANOVA for demonstrating no difference between 3 inputs for A/B (Figure 1B)
```{r}
#Sample A: Unblocked
A_UB<- My_ANOVA(PercentMapTo3Targets[,1:3])
#pr(>F) = 0.959 /BS: 0.97

#Sample A: Blocked
A_B<- My_ANOVA(PercentMapTo3Targets[,9:11])
#pr(>F) = 0.0832 / BS: 0.089

#Sample B: Unblocked
B_UB<- My_ANOVA(PercentMapTo3Targets[,4:6])
#pr(>F) = 0.944 / BS: 0.952

#Sample B: Blocked
B_B<- My_ANOVA(PercentMapTo3Targets[,12:14])
#pr(>F) = 0.06 / BS: 0.07
```

Significance test for comparing the 3 A unblocked samples vs the 3 A blocked samples, and for sample B
```{r}
#Ttest for comparing 3 A to 3 A and 3B to 3 B
ASamples<-Per_AnyTarget_16Samples[Per_AnyTarget_16Samples$Patient=="Sample A",]
BSamples<-Per_AnyTarget_16Samples[Per_AnyTarget_16Samples$Patient=="Sample B",]

t.test(ASamples[ASamples$Status=="Unblocked",2],ASamples[ASamples$Status=="Blocked",2],) #p=1.27e-05
t.test(BSamples[BSamples$Status=="Unblocked",2],BSamples[BSamples$Status=="Blocked",2],) #p=0.003
```

#5. Graph % for mapping to 3 targets individually for 4 unblocked vs 4 blocked samples (supplemental figure 1C)

```{r}
#Create new counts dataframe: A and B replicates collapsed by taking mean.
CollapsedCounts<-countsInput
CollapsedCounts$A_Unblocked <- rowMeans(CollapsedCounts[,1:3])
CollapsedCounts$A_Blocked <- rowMeans(CollapsedCounts[,9:11])
CollapsedCounts$B_Unblocked <- rowMeans(CollapsedCounts[,4:6])
CollapsedCounts$B_Blocked <- rowMeans(CollapsedCounts[,12:14])
CollapsedCounts<-CollapsedCounts[,c(17,19,7,8,18,20,15,16)]
colnames(CollapsedCounts)<-gsub("_", "-", colnames(CollapsedCounts))
CollapsedCounts<-as.data.frame(apply(CollapsedCounts, 2, as.integer))
rownames(CollapsedCounts)<-rownames(countsInput)
c_counts<-downsample.counts(CollapsedCounts)

#Get raw, downsampled counts for all 3 targets for al 16 samples
        #c_MapAnyTarget<- c_counts[rownames(c_counts) %in% c("hsa-miR-92a-3p", "hsa-miR-451a", "hsa-miR-486-5p"),] #for CL
        c_MapAnyTarget<- c_counts[rownames(c_counts) %in% c("miR-92a", "miR-451a", "miR-486"),] #For BaseSpace collapsed

#Get percentage of total for all 3 counts for all 16 samples 
c_PercentMapTo3Targets<- c_MapAnyTarget/colSums(c_counts) * 100

#prep for plotting
PM_melt<- c_PercentMapTo3Targets
PM_melt$species<- rownames(c_PercentMapTo3Targets)
PM_melt<-melt(PM_melt)
PM_melt$ID<- substr(PM_melt$variable, 1,1)
PM_melt$Status<- gsub("*.-", "", PM_melt$variable)
PM_melt$Status<- gsub("Unblocked", "A:UnBlocked",PM_melt$Status)
PM_melt<- PM_melt[order(PM_melt$ID, PM_melt$species),]
PM_melt$Order<- 1:nrow(c_MapAnyTarget) 


#plot
p<-ggplot(PM_melt, aes(y=value, x=ID, fill=Status))+
        geom_bar(stat="identity", position="dodge")+ 
        theme_classic()+
        theme(axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_wrap(~species,nrow=1)+
        ylab("Percent of reads mapping to target species")+
        xlab("")+
        scale_fill_manual("", values=c("A:UnBlocked"="turquoise3","Blocked"="firebrick3"),labels=c("Unblocked", "Blocked"))+
        ylim(0,100)+
        theme(axis.text.y   = element_text(size=12, colour = "black", face="bold"),
                axis.title.y  = element_text(size=14, face="bold", color="black"),
                axis.text.x  = element_text(size=14, face="bold"),
                panel.border = element_rect(colour = "black", fill=NA, size=2), 
                               strip.background = element_blank(),
                legend.title=element_blank(),
                legend.position = c(.12,.92),
                legend.background = element_rect(fill=NA, size=1, linetype="solid", color="black"),
                axis.text.x.bottom  =element_text(color="black", size=15),
                legend.key.size = unit(.4, "cm"),
                legend.spacing.y = unit(0, "mm"),
                legend.text=element_text(size=12, face="bold", color= "black"),
                strip.text = element_text(size= 8,face="bold")
              )


#calculate reduction in percent mapping for each species
MapReduction<- c_PercentMapTo3Targets
MapReduction$AReduce<- (MapReduction$`A-Unblocked` - MapReduction$`A-Blocked`)/MapReduction$`A-Unblocked` *100
MapReduction$BReduce<- (MapReduction$`B-Unblocked` - MapReduction$`B-Blocked`)/MapReduction$`B-Unblocked` *100
MapReduction$CReduce<- (MapReduction$`C-Unblocked` - MapReduction$`C-Blocked`)/MapReduction$`C-Unblocked` *100
MapReduction$DReduce<- (MapReduction$`D-Unblocked` - MapReduction$`D-Blocked`)/MapReduction$`D-Unblocked` *100

rowMeans(MapReduction[,9:12])
#451a reduced by 42% / BS: 44
#486-5p reduced by 80% / BS: 76
#92a reduced by 74% / BS: 76

```
Calculate odds ratio
```{r}
#Reformat
OR<- PM_melt
OR$BlockerStatus<-gsub(".*-", "", OR$variable)
OR$Group<-paste(OR$species, OR$BlockerStatus, sep="_")
OR<-OR[c(1:18,21:24),]
OR_mean<- OR %>% group_by(Group) %>% mutate(bad=mean(value)) %>% as.data.frame()
OR_mean<-OR_mean[!(duplicated(OR_mean$Group)),]
OR_mean$good<-100-OR_mean$bad
rownames(OR_mean)<-OR_mean$Group


allORs<-c()
for (i in seq(1,5,2)){
  print(i)
  df<-OR_mean[i:(i+1),9:10]
  or_fit<-oddsratio(as.matrix(df))
  allORs[[i]]<-or_fit$measure
  
  
}

allORs
```
miR-1301 is highest off target. Calculate odds ratio for its change:
```{r}
OTmiRs<-c("miR-1301","miR-25", "miR-92b")
OTs<-counts[rownames(counts) %in% OTmiRs,]
OTs<-OTs/colSums(counts)*100
OT_PM<-data.frame(bad=c(rowMeans(OTs[,c(1:8)]),
                        rowMeans(OTs[,c(9:16)])),
                  species=rep(OTmiRs, 2),
                  BlockerStatus=c(rep("Unblocked", length(OTmiRs)),
                                  rep("Blocked", length(OTmiRs))))
OT_PM$good<- 100-OT_PM$bad
rownames(OT_PM)<-paste(OT_PM$species,OT_PM$BlockerStatus, sep="_")
OT_PM<-OT_PM[,c(1,4)]*200


OT_PM<-OT_PM[order(rownames(OT_PM),decreasing=TRUE),]


allOTORs<-c()
for (i in seq(1,5,2)){
  print(i)
  df<-OT_PM[i:(i+1),1:2]
  or_fit<-oddsratio(as.matrix(df))
  allOTORs[[i]]<-or_fit$measure
  
  
}

allOTORs

```



#6: Percent of reads mapping to all 11 mature/isomiRs in target group (Supplemental figure 1E)
```{r}
####NOTE: Set inputCounts as "Basespace_counts" and run previous chunks before executing here

c_MapAnyTarget<-c_counts[rownames(c_counts) %in% c(rownames(counts[grep("mir-486", rownames(counts), ignore.case=TRUE ),]),
                                                           rownames(counts[grep("mir-451a", rownames(counts), ignore.case=TRUE ),]),
                                                           rownames(counts[grep("mir-92a", rownames(counts), ignore.case=TRUE ),])),]#for Basespace not         collapsed
                                                   
#Get percentage of total for all 11 mature/isomir species for all 16 samples 
c_PercentMapTo3Targets<- c_MapAnyTarget/colSums(c_counts) * 100

#prep for plotting
PM_melt<- c_PercentMapTo3Targets
PM_melt$species<- rownames(c_PercentMapTo3Targets)
PM_melt<-melt(PM_melt)
PM_melt$ID<- substr(PM_melt$variable, 1,1)
PM_melt$Status<- gsub("*.-", "", PM_melt$variable)
PM_melt$Status<- gsub("Unblocked", "A:UnBlocked",PM_melt$Status)
PM_melt<- PM_melt[order(PM_melt$ID, PM_melt$species),]
PM_melt$Order<- 1:nrow(c_MapAnyTarget) 


#plot
p<-ggplot(PM_melt, aes(y=value, x=ID, fill=Status))+
        geom_bar(stat="identity", position="dodge")+ 
        theme_classic()+
        theme(axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_wrap(~species,nrow=1)+
        ylab("Percent of reads mapping to target species")+
        xlab("")+
        scale_fill_manual("", values=c("A:UnBlocked"="turquoise3","Blocked"="firebrick3"),labels=c("Unblocked", "Blocked"))+
        ylim(0,100)+
        theme(axis.text.y   = element_text(size=12, colour = "black", face="bold"),
                axis.title.y  = element_text(size=14, face="bold", color="black"),
                axis.text.x  = element_text(size=14, face="bold"),
                panel.border = element_rect(colour = "black", fill=NA, size=2), 
                               strip.background = element_blank(),
                legend.title=element_blank(),
                legend.position = c(.12,.92),
                legend.background = element_rect(fill=NA, size=1, linetype="solid", color="black"),
                axis.text.x.bottom  =element_text(color="black", size=15),
                legend.key.size = unit(.4, "cm"),
                legend.spacing.y = unit(0, "mm"),
                legend.text=element_text(size=12, face="bold", color= "black"),
                strip.text = element_text(size= 8,face="bold")
              )


#calculate reduction in percent mapping for each species
MapReduction<- c_PercentMapTo3Targets
MapReduction$AReduce<- (MapReduction$`A-Unblocked` - MapReduction$`A-Blocked`)/MapReduction$`A-Unblocked` *100
MapReduction$BReduce<- (MapReduction$`B-Unblocked` - MapReduction$`B-Blocked`)/MapReduction$`B-Unblocked` *100
MapReduction$CReduce<- (MapReduction$`C-Unblocked` - MapReduction$`C-Blocked`)/MapReduction$`C-Unblocked` *100
MapReduction$DReduce<- (MapReduction$`D-Unblocked` - MapReduction$`D-Blocked`)/MapReduction$`D-Unblocked` *100

rowMeans(MapReduction[,9:12])
#451a reduced by 42% / BS: 44
#486-5p reduced by 80% / BS: 76
#92a reduced by 74% / BS: 76
```

```{r}
sessionInfo()
```

